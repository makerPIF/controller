<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRC ÌÉêÏÇ¨Î°úÎ≤Ñ Ïª®Ìä∏Î°§Îü¨</title>
    
    <!-- PWA ÏÑ§Ï†ï -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuuLrCDtg5DsgqzroZzrsoQg7KGw7KKF6riwIiwKICAic2hvcnRfbmFtZSI6ICLroZzrsoQg7KGw7KKF6riwIiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMGEwYTIzIiwKICAidGhlbWVfY29sb3IiOiAiIzAwZmZmZiIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lpSUhacFpYZENiM2c5SWpBZ01DQXhNamdnTVRJNElpQm1hV3hzUFNJaU1EQm1abVptSWlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpUGp4amFYSmpiR1VnWTNnOUlqWTBJaUJqZVQwaU5qUWlJSEk5SWpVNElpQm1hV3hzUFNJaU1EQm1abVptSWk4K1BITmhaM04yWlc1bFpDVnRiRHdpZVdGeUlHUmhkR0V1YUd4dUlHcHpWblJ6TkNGa2IzbzNZV2R3WlRGdmJuUXdaR3BrTFVKSk9GSlhWWE1qZFVSUmJVczNWWFZVWVZsalpHWnFPWFZSTnpVc2JVNWFNbWxrY1RJME5VdGtZbFJwWkdoeFNsVnZia3RVV0UxdGJFOXNNamMySUNBaUhBdmNtVmpkRDQ4TDNOMlp6ND0iLAogICAgICAic2l6ZXMiOiAiMTI4eDEyOCIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXSwKICAiY2F0ZWdvcmllcyI6IFsidXRpbGl0aWVzIiwgInRvb2xzIl0sCiAgImRlc2NyaXB0aW9uIjogIuq4sOqzvOydmCDslYTrp4jsnoTrqqUg67iU66Gj7Yar7Iqk66qo65OIIOyKpOuniOydtO2PsOyXkOyEnCDrsajrsJzsnYQg7KGw7KKF7ZWg7IiYIOyeiOuKlCDslrTtlIRcuOuygyIKfQ==">
    <meta name="theme-color" content="#00ffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Î°úÎ≤Ñ Ï°∞Ï¢ÖÍ∏∞">
    
    <!-- ÌÑ∞Ïπò ÏïÑÏù¥ÏΩò -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9IiMwMGZmZmYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNjQiIGN5PSI2NCIgcj0iNTgiIGZpbGw9IiMwMGZmZmYiLz48c2FnZW5lcmF0ZWQgbWwwiXRhdGEuaGxuIGpzVnRzNFFkb3o3YWdwZTFvbnQwZGprZC1CSTlSV1VTYW1VRGxLN1V1VGFZalpmajl1UTc1LG1OWjJpZHEyNDVLZGJUaWRocVNKVW9ua1RYMXRsT2wyNzYgICAiHA08cmVjdD48L3N2Zz4=">
    
    <!-- Ï†ÑÏ≤¥ÌôîÎ©¥ Î∞è Ïä§ÌÉ†ÎìúÏñºÎ°† Î™®Îìú ÏßÄÏõê -->
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a0a23 0%, #1a1a3a 50%, #2a2a4a 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Îã¨ ÌëúÎ©¥ Î∞∞Í≤Ω */
        .moon-surface {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: linear-gradient(180deg, #5a5a5a 0%, #3a3a3a 100%);
            border-radius: 50% 50% 0 0 / 20% 20% 0 0;
        }

        /* Î≥ÑÎì§ */
        .stars {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #fff, transparent),
                radial-gradient(2px 2px at 40px 70px, #fff, transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(1px 1px at 130px 80px, #fff, transparent),
                radial-gradient(2px 2px at 160px 30px, #fff, transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: twinkle 3s ease-in-out infinite alternate;
        }

        @keyframes twinkle {
            0% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
            margin-bottom: 10px;
        }

        .status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid #00ffff;
            margin-bottom: 20px;
        }

        .bluetooth-section {
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #4a9eff;
            margin-bottom: 20px;
        }

        .bluetooth-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4a9eff, #0066cc);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #0066cc, #4a9eff);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(74, 158, 255, 0.3);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff4757, #cc3644);
            color: white;
        }

        .device-list {
            max-height: 120px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .device-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 12px;
        }

        .device-item:hover {
            background: rgba(74, 158, 255, 0.3);
        }

        .controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .dpad {
            display: grid;
            grid-template-areas: 
                ". up ."
                "left center right"
                ". down .";
            gap: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 20px;
            border: 2px solid #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .control-btn {
            width: 80px;
            height: 80px;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            background: linear-gradient(45deg, #333, #555);
            color: #fff;
            border: 2px solid #00ffff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .control-btn:active {
            background: linear-gradient(45deg, #00ffff, #0099cc);
            transform: translateY(2px);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.8);
        }

        .btn-up { grid-area: up; }
        .btn-down { grid-area: down; }
        .btn-left { grid-area: left; }
        .btn-right { grid-area: right; }
        .btn-center { 
            grid-area: center; 
            background: linear-gradient(45deg, #ff4757, #cc3644);
            border-color: #ff4757;
        }

        .rover-info {
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #00ffff;
        }

        .command-display {
            font-size: 24px;
            font-weight: bold;
            color: #00ffff;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #00ffff;
        }

        .connected {
            color: #00ff00;
        }

        .disconnected {
            color: #ff4757;
        }

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 480px) {
            .control-btn {
                width: 60px;
                height: 60px;
                font-size: 16px;
            }
            
            .title {
                font-size: 20px;
            }
            
            .dpad {
                gap: 8px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="stars"></div>
    <div class="moon-surface"></div>
    
    <div class="container">
        <div class="header">
            <div class="title">üåô SRC ÌÉêÏÇ¨Î°úÎ≤Ñ Ïª®Ìä∏Î°§Îü¨</div>
        </div>

        <div class="status">
            <span>Ïó∞Í≤∞ ÏÉÅÌÉú:</span>
            <span id="connectionStatus" class="disconnected">Ïó∞Í≤∞ ÏïàÎê®</span>
        </div>

        <div class="bluetooth-section">
            <div class="bluetooth-controls">
                <button class="btn btn-primary" id="scanBtn">Î∏îÎ£®Ìà¨Ïä§ Í≤ÄÏÉâ</button>
                <button class="btn btn-danger" id="disconnectBtn" disabled>Ïó∞Í≤∞ Ìï¥Ï†ú</button>
            </div>
            <div id="deviceList" class="device-list"></div>
        </div>

        <div class="controls">
            <div class="dpad">
                <button class="control-btn btn-up" data-command="F">
                    ‚¨ÜÔ∏è<br>Ï†ÑÏßÑ
                </button>
                <button class="control-btn btn-left" data-command="L">
                    ‚¨ÖÔ∏è<br>Ï¢åÌöåÏ†Ñ
                </button>
                <button class="control-btn btn-center" data-command="S">
                    ‚èπÔ∏è<br>Ï†ïÏßÄ
                </button>
                <button class="control-btn btn-right" data-command="R">
                    ‚û°Ô∏è<br>Ïö∞ÌöåÏ†Ñ
                </button>
                <button class="control-btn btn-down" data-command="B">
                    ‚¨áÔ∏è<br>ÌõÑÏßÑ
                </button>
            </div>
        </div>

        <div class="rover-info">
            <div class="command-display" id="currentCommand">Î™ÖÎ†π: ÎåÄÍ∏∞Ï§ë</div>
            <div>ü§ñ Î°úÎ≤ÑÍ∞Ä Î™ÖÎ†πÏùÑ Í∏∞Îã§Î¶¨Í≥† ÏûàÏäµÎãàÎã§</div>
        </div>
    </div>

    <script>
        class BluetoothRoverController {
            constructor() {
                this.device = null;
                this.characteristic = null;
                this.isConnected = false;
                this.currentCommand = 'S';
                
                this.initEventListeners();
            }

            initEventListeners() {
                // Î∏îÎ£®Ìà¨Ïä§ Ï†úÏñ¥ Î≤ÑÌäº
                document.getElementById('scanBtn').addEventListener('click', () => this.scanForDevices());
                document.getElementById('disconnectBtn').addEventListener('click', () => this.disconnect());

                // Ï°∞Ï¢Ö Î≤ÑÌäºÎì§
                const controlButtons = document.querySelectorAll('.control-btn');
                controlButtons.forEach(btn => {
                    // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ (Î™®Î∞îÏùº)
                    btn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.sendCommand(btn.dataset.command);
                    });
                    
                    btn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        if (btn.dataset.command !== 'S') {
                            this.sendCommand('S'); // ÌÑ∞Ïπò ÎÅùÎÇòÎ©¥ Ï†ïÏßÄ
                        }
                    });

                    // ÎßàÏö∞Ïä§ Ïù¥Î≤§Ìä∏ (Îç∞Ïä§ÌÅ¨ÌÜ±)
                    btn.addEventListener('mousedown', () => {
                        this.sendCommand(btn.dataset.command);
                    });
                    
                    btn.addEventListener('mouseup', () => {
                        if (btn.dataset.command !== 'S') {
                            this.sendCommand('S'); // ÎßàÏö∞Ïä§ Î≤ÑÌäº ÎÜìÏúºÎ©¥ Ï†ïÏßÄ
                        }
                    });

                    // ÎßàÏö∞Ïä§Í∞Ä Î≤ÑÌäºÏùÑ Î≤óÏñ¥ÎÇòÎ©¥ Ï†ïÏßÄ
                    btn.addEventListener('mouseleave', () => {
                        if (btn.dataset.command !== 'S') {
                            this.sendCommand('S');
                        }
                    });
                });
            }

            async scanForDevices() {
                try {
                    // HM10, HC06 Îì± ÏùºÎ∞òÏ†ÅÏù∏ Î∏îÎ£®Ìà¨Ïä§ Î™®Îìà Í≤ÄÏÉâ
                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: [
                            '0000ffe0-0000-1000-8000-00805f9b34fb', // HM10 ÏÑúÎπÑÏä§
                            '00001101-0000-1000-8000-00805f9b34fb'  // HC06 SPP ÏÑúÎπÑÏä§
                        ]
                    });

                    this.device = device;
                    await this.connectToDevice();
                } catch (error) {
                    console.error('Î∏îÎ£®Ìà¨Ïä§ Í≤ÄÏÉâ Ïò§Î•ò:', error);
                    alert('Î∏îÎ£®Ìà¨Ïä§ Í≤ÄÏÉâÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†ÄÍ∞Ä Web BluetoothÎ•º ÏßÄÏõêÌïòÎäîÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                }
            }

            async connectToDevice() {
                try {
                    if (!this.device) return;

                    console.log('Ïó∞Í≤∞ Ï§ë:', this.device.name);
                    
                    const server = await this.device.gatt.connect();
                    
                    // HM10 Î™®Îìà ÏãúÎèÑ
                    try {
                        const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
                        this.characteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
                    } catch (e) {
                        // HC06 ÎòêÎäî Îã§Î•∏ Î™®Îìà ÏãúÎèÑ
                        try {
                            const service = await server.getPrimaryService('00001101-0000-1000-8000-00805f9b34fb');
                            this.characteristic = await service.getCharacteristic('00001101-0000-1000-8000-00805f9b34fb');
                        } catch (e2) {
                            // Í∞ÄÎä•Ìïú Î™®Îì† ÏÑúÎπÑÏä§ Í≤ÄÏÉâ
                            const services = await server.getPrimaryServices();
                            for (let service of services) {
                                try {
                                    const characteristics = await service.getCharacteristics();
                                    if (characteristics.length > 0) {
                                        this.characteristic = characteristics[0];
                                        break;
                                    }
                                } catch (e3) {
                                    continue;
                                }
                            }
                        }
                    }

                    if (this.characteristic) {
                        this.isConnected = true;
                        this.updateConnectionStatus();
                        this.sendCommand('S'); // Ï¥àÍ∏∞ Ï†ïÏßÄ Î™ÖÎ†π
                        
                        // Ïó∞Í≤∞ Ìï¥Ï†ú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
                        this.device.addEventListener('gattserverdisconnected', () => {
                            this.isConnected = false;
                            this.updateConnectionStatus();
                        });
                    } else {
                        throw new Error('Ï†ÅÏ†àÌïú ÌäπÏÑ±ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                    }
                } catch (error) {
                    console.error('Ïó∞Í≤∞ Ïò§Î•ò:', error);
                    alert(`Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${error.message}`);
                }
            }

            async sendCommand(command) {
                if (!this.isConnected || !this.characteristic) {
                    console.log('Î∏îÎ£®Ìà¨Ïä§Í∞Ä Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏùå');
                    return;
                }

                try {
                    const encoder = new TextEncoder();
                    await this.characteristic.writeValue(encoder.encode(command));
                    
                    this.currentCommand = command;
                    this.updateCommandDisplay();
                } catch (error) {
                    console.error('Î™ÖÎ†π Ï†ÑÏÜ° Ïò§Î•ò:', error);
                }
            }

            async disconnect() {
                if (this.device && this.device.gatt.connected) {
                    await this.device.gatt.disconnect();
                }
                this.isConnected = false;
                this.device = null;
                this.characteristic = null;
                this.updateConnectionStatus();
            }

            updateConnectionStatus() {
                const statusElement = document.getElementById('connectionStatus');
                const disconnectBtn = document.getElementById('disconnectBtn');
                
                if (this.isConnected) {
                    statusElement.textContent = `Ïó∞Í≤∞Îê®: ${this.device.name || 'Ïïå Ïàò ÏóÜÎäî Ïû•Ïπò'}`;
                    statusElement.className = 'connected';
                    disconnectBtn.disabled = false;
                } else {
                    statusElement.textContent = 'Ïó∞Í≤∞ ÏïàÎê®';
                    statusElement.className = 'disconnected';
                    disconnectBtn.disabled = true;
                }
            }

            updateCommandDisplay() {
                const commandDisplay = document.getElementById('currentCommand');
                const commandNames = {
                    'F': 'Ï†ÑÏßÑ',
                    'B': 'ÌõÑÏßÑ',
                    'L': 'Ï¢åÌöåÏ†Ñ',
                    'R': 'Ïö∞ÌöåÏ†Ñ',
                    'S': 'Ï†ïÏßÄ'
                };
                
                commandDisplay.textContent = `Î™ÖÎ†π: ${commandNames[this.currentCommand]} (${this.currentCommand})`;
            }
        }

        // PWA Service Worker Îì±Î°ù
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,Y29uc3QgQ0FDSEVfTkFNRSA9ICdyb3Zlci1jb250cm9sbGVyLXYxJzsKY29uc3QgdXJsc1RvQ2FjaGUgPSBbCiAgJy4vJwpdOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4gewogIGV2ZW50LndhaXRVbnRpbCgKICAgIGNhY2hlcy5vcGVuKENBQ0hFX05BTUUpCiAgICAgIC50aGVuKGNhY2hlID0+IGNhY2hlLmFkZEFsbCh1cmxzVG9DYWNoZSkpCiAgKTsKfSk7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZXZlbnQgPT4gewogIGV2ZW50LnJlc3BvbmRXaXRoKAogICAgY2FjaGVzLm1hdGNoKGV2ZW50LnJlcXVlc3QpCiAgICAgIC50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICByZXR1cm4gcmVzcG9uc2UgfHwgZmV0Y2goZXZlbnQucmVxdWVzdCk7CiAgICAgIH0pCiAgKTsKfSk7')
              .then(() => console.log('Service Worker Îì±Î°ù ÏôÑÎ£å'))
              .catch(error => console.log('Service Worker Îì±Î°ù Ïã§Ìå®:', error));
        }

        // Web Bluetooth ÏßÄÏõê ÌôïÏù∏
        if ('bluetooth' in navigator) {
            window.controller = new BluetoothRoverController();
        } else {
            alert('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî Web BluetoothÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§. Chrome Î∏åÎùºÏö∞Ï†ÄÎ•º ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.');
        }

        // PWA ÏÑ§Ïπò ÌîÑÎ°¨ÌîÑÌä∏
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // ÏÑ§Ïπò Î≤ÑÌäº ÌëúÏãú
            const installBtn = document.createElement('button');
            installBtn.className = 'btn btn-primary';
            installBtn.textContent = 'üì± Ïï±ÏúºÎ°ú ÏÑ§Ïπò';
            installBtn.style.position = 'fixed';
            installBtn.style.top = '10px';
            installBtn.style.right = '10px';
            installBtn.style.zIndex = '1000';
            
            installBtn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('ÏÇ¨Ïö©ÏûêÍ∞Ä PWA ÏÑ§ÏπòÎ•º ÏäπÏù∏ÌñàÏäµÎãàÎã§');
                        installBtn.remove();
                    }
                    deferredPrompt = null;
                });
            });
            
            document.body.appendChild(installBtn);
        });

        // ÌéòÏù¥ÏßÄ Ïù¥ÌÉà Ïãú Ï†ïÏßÄ Î™ÖÎ†π Ï†ÑÏÜ°
        window.addEventListener('beforeunload', () => {
            if (window.controller && window.controller.isConnected) {
                window.controller.sendCommand('S');
            }
        });
    </script>
</body>
</html>